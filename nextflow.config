/*
 * =============================================================================
 * ARG Phylogenomics Toolkit â€” Nextflow Configuration
 * =============================================================================
 */

// Pipeline metadata
manifest {
    name            = 'ARG-phylogenomics'
    author          = 'engkinandatama'
    description     = 'Config-driven Nextflow pipeline for evolutionary analysis of antibiotic resistance genes'
    mainScript      = 'main.nf'
    nextflowVersion = '>=23.04'
    version         = '0.1.0'
}

// Default parameters (can be overridden by -params-file)
params {
    // Config file path
    config_file   = "${projectDir}/conf/project.yaml"

    // Output directory
    outdir        = "${projectDir}/results"

    // Max resources (overridden by profiles)
    max_cpus      = 2
    max_memory    = '8.GB'
    max_time      = '24.h'

    // Help
    help          = false

    // Flat params used by modules (defaults; overridden at runtime by YAML)
    clustering_identity  = 0.99
    clustering_word_size = 10
    qc_min_len           = 300
    qc_max_ambig         = 5
    p_threshold          = 0.05
    correction_method    = 'BH'
}

// Process defaults
process {
    // Default resources
    cpus   = 1
    memory = '2.GB'
    time   = '2.h'

    // Error strategy: retry once, then fail
    errorStrategy = { task.exitStatus in [104, 134, 137, 139, 140, 143] ? 'retry' : 'terminate' }
    maxRetries    = 1

    // Labels for resource allocation
    withLabel: 'process_low' {
        cpus   = 1
        memory = '1.GB'
        time   = '1.h'
    }
    withLabel: 'process_medium' {
        cpus   = 2
        memory = '4.GB'
        time   = '4.h'
    }
    withLabel: 'process_high' {
        cpus   = params.max_cpus as int
        memory = '6.GB'
        time   = '8.h'
    }
    withLabel: 'process_internet' {
        // For processes that access the internet (NCBI, InterPro)
        maxForks = 3    // Limit concurrent API calls
        time     = '2.h'
    }
}

// Profiles
profiles {

    // Local (WSL or native Linux)
    local {
        process.executor = 'local'
        conda.enabled    = true
        conda.useMamba   = true
    }

    // Conda environment
    conda {
        conda.enabled    = true
        conda.useMamba   = true
        process.conda    = "${projectDir}/containers/environment.yml"
    }

    // Docker
    docker {
        docker.enabled   = true
        docker.runOptions = '-u $(id -u):$(id -g)'
    }

    // Singularity (for HPC)
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
    }

    // GitHub Codespaces
    codespaces {
        process.executor = 'local'
        conda.enabled    = true
        conda.useMamba   = true
        params.max_cpus  = 4
        params.max_memory = '8.GB'
    }

    // Gitpod
    gitpod {
        process.executor = 'local'
        conda.enabled    = true
        conda.useMamba   = true
        params.max_cpus  = 4
        params.max_memory = '8.GB'
    }

    // Test profile (mini dataset)
    test {
        process.executor = 'local'
        conda.enabled    = true
        conda.useMamba   = true
        params.config_file = "${projectDir}/test/test_config.yaml"
        params.max_cpus  = 2
        params.max_memory = '4.GB'
    }
}

// Timeline, report, trace
timeline {
    enabled = true
    file    = "${params.outdir}/pipeline_info/timeline.html"
    overwrite = true
}

report {
    enabled = true
    file    = "${params.outdir}/pipeline_info/report.html"
    overwrite = true
}

trace {
    enabled = true
    file    = "${params.outdir}/pipeline_info/trace.txt"
    overwrite = true
    fields  = 'task_id,hash,native_id,name,status,exit,submit,duration,realtime,%cpu,%mem,rss,peak_rss'
}

dag {
    enabled = true
    file    = "${params.outdir}/pipeline_info/dag.svg"
    overwrite = true
}
