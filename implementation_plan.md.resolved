# ARG Phylogenomics Toolkit ‚Äî Implementation Plan (Final)

Config-driven Nextflow DSL2 pipeline for evolutionary analysis of antibiotic resistance genes. Reusable for any organism/gene set via single YAML config.

---

## Pipeline Flow

```mermaid
flowchart TD
    A["üì• 1. NCBI Fetch"] --> B["üîÑ 2. CD-HIT Clustering"]
    B --> C["üßπ 3. QC / Filter / Dedup"]
    C --> D["üß¨ 4. Codon Alignment (MAFFT)"]
    D --> E["‚úÇÔ∏è 5. Alignment Trimming (TrimAl)"]
    E --> F["üìä 6. Alignment QC + Saturation Test"]
    F --> G["üå≥ 7. Gene Trees (IQ-TREE2 + rooting)"]
    G --> H["üîÄ 8. GARD Recombination"]
    H -->|"partitions"| I["üß™ 9. Selection (HyPhy √ó7, Code 11)"]
    I --> J["üìê 10. Multiple Testing Correction"]

    K["üè† Housekeeping Genes"] --> L["üå≤ 11. Species Tree"]
    G --> M["üîÑ 12. HGT Detection"]
    L --> M
    C --> N["üè∑Ô∏è 13. CARD Variant Naming"]

    E --> O["üîç 14. Domain Annotation (HMMER)"]
    J --> P["üìä 15. Domain-Selection Overlay"]
    O --> P

    C --> Q["üï∏Ô∏è 16. Metadata Network + Co-selection"]
    G --> R["‚è±Ô∏è 17. Temporal Signal"]

    J --> S["üìã 18. Reporting"]
    M --> S
    P --> S
    Q --> S
    R --> S
    N --> S
    F --> S
    S --> T["üìù Methods Paragraph"]
    S --> U["üó∫Ô∏è Geographic Map"]
    S --> V["üåø Tanglegram"]
```

---

## Project Structure

```
E:\Project\ARG-phylogeny\
‚îú‚îÄ‚îÄ main.nf                          # Main workflow
‚îú‚îÄ‚îÄ nextflow.config                  # Profiles & resources
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ fetch_sequences.nf           # Module 1
‚îÇ   ‚îú‚îÄ‚îÄ cluster_cdhit.nf             # Module 2 (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ qc_filter.nf                 # Module 3
‚îÇ   ‚îú‚îÄ‚îÄ align_codon.nf               # Module 4
‚îÇ   ‚îú‚îÄ‚îÄ trim_alignment.nf            # Module 5 (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ alignment_qc.nf             # Module 6 (NEW: QC stats + saturation)
‚îÇ   ‚îú‚îÄ‚îÄ build_tree.nf                # Module 7 (FIXED: outgroup rooting)
‚îÇ   ‚îú‚îÄ‚îÄ recombination_gard.nf        # Module 8
‚îÇ   ‚îú‚îÄ‚îÄ selection_hyphy.nf           # Module 9 (FIXED: Code 11, partitions)
‚îÇ   ‚îú‚îÄ‚îÄ multiple_testing.nf          # Module 10 (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ species_tree.nf              # Module 11
‚îÇ   ‚îú‚îÄ‚îÄ hgt_detection.nf             # Module 12
‚îÇ   ‚îú‚îÄ‚îÄ variant_naming.nf            # Module 13 (NEW)
‚îÇ   ‚îú‚îÄ‚îÄ domain_annotation.nf         # Module 14
‚îÇ   ‚îú‚îÄ‚îÄ domain_overlay.nf            # Module 15
‚îÇ   ‚îú‚îÄ‚îÄ metadata_network.nf          # Module 16 (ENHANCED: co-selection)
‚îÇ   ‚îú‚îÄ‚îÄ temporal_signal.nf           # Module 17 (NEW)
‚îÇ   ‚îî‚îÄ‚îÄ reporting.nf                 # Module 18 (ENHANCED)
‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îú‚îÄ‚îÄ fetch_ncbi.py
‚îÇ   ‚îú‚îÄ‚îÄ qc_sequences.py
‚îÇ   ‚îú‚îÄ‚îÄ codon_align.py
‚îÇ   ‚îú‚îÄ‚îÄ saturation_test.py           # NEW: Xia's test
‚îÇ   ‚îú‚îÄ‚îÄ root_tree.py                 # NEW: midpoint/outgroup rooting
‚îÇ   ‚îú‚îÄ‚îÄ partition_gard.py            # NEW: split alignment by GARD breakpoints
‚îÇ   ‚îú‚îÄ‚îÄ correct_pvalues.py           # NEW: Holm-Bonferroni / FDR
‚îÇ   ‚îú‚îÄ‚îÄ gc_cai_analysis.py
‚îÇ   ‚îú‚îÄ‚îÄ tree_comparison.py
‚îÇ   ‚îú‚îÄ‚îÄ card_lookup.py               # NEW: CARD/ResFinder variant naming
‚îÇ   ‚îú‚îÄ‚îÄ domain_overlay.py            # Static (matplotlib) + Interactive (Plotly)
‚îÇ   ‚îú‚îÄ‚îÄ build_network.py             # ENHANCED: co-selection analysis
‚îÇ   ‚îú‚îÄ‚îÄ temporal_signal.py           # NEW: root-to-tip regression
‚îÇ   ‚îú‚îÄ‚îÄ tanglegram.py                # NEW: gene vs species tree comparison
‚îÇ   ‚îú‚îÄ‚îÄ geo_map.py                   # NEW: geographic distribution
‚îÇ   ‚îú‚îÄ‚îÄ parse_hyphy.py
‚îÇ   ‚îú‚îÄ‚îÄ generate_report.py           # ENHANCED: summary stats
‚îÇ   ‚îî‚îÄ‚îÄ generate_methods.py          # NEW: auto methods paragraph
‚îú‚îÄ‚îÄ conf/
‚îÇ   ‚îî‚îÄ‚îÄ project.yaml                 # ‚≠ê SINGLE CONFIG
‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îú‚îÄ‚îÄ report.jinja2
‚îÇ   ‚îî‚îÄ‚îÄ methods.jinja2               # NEW
‚îú‚îÄ‚îÄ containers/
‚îÇ   ‚îî‚îÄ‚îÄ environment.yml
‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îî‚îÄ‚îÄ test_data/
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îú‚îÄ‚îÄ LEARNING_GUIDE.md
‚îÇ   ‚îî‚îÄ‚îÄ PIPELINE_DIAGRAM.md
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ README.md
```

---

## Single Config: `conf/project.yaml`

```yaml
project:
  name: "ARG-Klebsiella"
  organism: "Klebsiella pneumoniae"
  email: "your@email.com"

genes:
  targets:
    - name: blaCTX-M
      query: "(Klebsiella pneumoniae[Organism]) AND blaCTX-M[Gene] AND CDS[Feature key]"
      max_records: 200
    # ... more genes

  housekeeping:
    - name: rpoB
      query: "..."
    # ... more housekeeping genes

analysis:
  clustering:
    identity: 0.99             # CD-HIT threshold
    enabled: true

  qc:
    min_len_nt: 300
    max_ambig_pct: 5

  alignment:
    protein_guided: true
    trimming:
      tool: trimal              # trimal | clipkit | bmge
      mode: automated1

  saturation:
    test: xia                   # Xia's test
    action_if_saturated: warn   # warn | exclude_3rd_pos | use_aa_tree

  phylogeny:
    bootstrap: 1000
    model: MFP
    outgroup_strategy: midpoint # midpoint | ortholog
    outgroup_queries: {}        # per-gene outgroup queries if strategy=ortholog

  selection:
    genetic_code: "Bacterial and Plant Plastid"  # ‚úÖ Code 11
    methods: [SLAC, FEL, MEME, FUBAR, BUSTED, aBSREL, RELAX]
    p_threshold: 0.05
    q_threshold: 0.1
    recombination_aware: true
    multiple_testing: BH        # BH (Benjamini-Hochberg) | holm

  hgt:
    topology_test: AU
    gc_content: true
    codon_usage: true

  domains:
    pfam_db: Pfam-A.hmm
    overlay_selection: true

  variant_naming:
    database: card              # card | resfinder
    enabled: true

  temporal:
    root_to_tip: true

  co_selection:
    test: fisher                # Fisher's exact test
    visualize: true

output:
  static_plots: true            # PNG/PDF
  interactive_plots: true       # HTML (Plotly)
  geographic_map: true
  tanglegram: true
  network_format: gexf
  report_format: [markdown, html]
  methods_paragraph: true       # Auto-generate Methods text
```

---

## Module Details

### Modules 1-3: Data Acquisition

| Module | Tool | What it does |
|--------|------|-------------|
| 1. Fetch | BioPython/Entrez | Download CDS from NCBI per gene query |
| 2. CD-HIT | cd-hit-est | Cluster at 99% identity, keep representatives |
| 3. QC | BioPython | Filter: length, ambiguity, reading frame, stop codons, dedup |

---

### Modules 4-6: Alignment & QC

| Module | Tool | What it does |
|--------|------|-------------|
| 4. Align | MAFFT | Protein-guided codon alignment |
| 5. Trim | TrimAl | Remove poorly aligned/gap-rich regions (`-automated1`) |
| 6. QC+Sat | Custom Python | Alignment stats + Xia's saturation test per codon position |

> [!IMPORTANT]
> Module 5 (trimming) saves column mapping so selection site positions can be traced back to original alignment coordinates.

---

### Modules 7-10: Phylogeny & Selection

| Module | Tool | What it does |
|--------|------|-------------|
| 7. Trees | IQ-TREE2 | Gene tree with MFP + bootstrap + **rooting** |
| 8. GARD | HyPhy | Recombination breakpoint detection ‚Üí partition alignment |
| 9. Selection | HyPhy (√ó7) | **Per partition**, **Code 11**, 7 methods in parallel |
| 10. Correction | Python/statsmodels | Holm-Bonferroni / BH FDR across tests |

> [!CAUTION]
> **Strict order**: Module 8 (GARD) **must complete** before Module 9 (Selection) starts. Nextflow channel dependency enforces this.

---

### Modules 11-13: Comparative & Naming

| Module | Tool | What it does |
|--------|------|-------------|
| 11. Species Tree | MAFFT + IQ-TREE2 | Housekeeping genes ‚Üí concatenated species tree |
| 12. HGT | ete3 + IQ-TREE2 + Python | Topology comparison (RF + AU) + parametric (GC + CAI) |
| 13. Variant Naming | BLAST + CARD | Match sequences to known ARG variant names |

---

### Modules 14-16: Functional & Network

| Module | Tool | What it does |
|--------|------|-------------|
| 14. Domains | HMMER (hmmscan) | Pfam domain annotation per gene |
| 15. Overlay | matplotlib + Plotly | Domain map + selected sites ‚Üí PNG/PDF + HTML |
| 16. Network | NetworkX | Strain-gene co-occurrence + co-selection (Fisher's test) |

---

### Modules 17-18: Temporal & Reporting

| Module | Tool | What it does |
|--------|------|-------------|
| 17. Temporal | Python | Root-to-tip regression (date vs divergence) |
| 18. Reporting | Jinja2 + Python | Per-gene report + summary + tanglegram + geo map + methods paragraph |

---

## Verification Plan

### Phase 1: Structure
```bash
nextflow run main.nf -stub -profile local    # Validates DAG, no data
```

### Phase 2: Mini Test
```bash
nextflow run main.nf -profile test            # 10 seqs/gene from test_data/
```

### Phase 3: Full Run
```bash
nextflow run main.nf -params-file conf/project.yaml -profile conda
```

### Validation Checklist
- [ ] Genetic code = "Bacterial and Plant Plastid" in all HyPhy calls
- [ ] TrimAl runs before tree building
- [ ] Trees are rooted (midpoint or outgroup)
- [ ] GARD completes before selection starts (check DAG)
- [ ] Multiple testing correction applied to p-values
- [ ] CD-HIT reduces dataset size meaningfully
- [ ] Saturation test produces plots for each codon position
- [ ] Domain overlay has both PNG and HTML output
- [ ] HGT report shows RF distance + AU p-value + GC% + CAI
- [ ] Methods paragraph includes all tool versions

---

## Learning Roadmap

| Phase | Modules Built | Nextflow Concepts |
|:---:|--------|--------------------------|
| 1 | Fetch + CD-HIT + QC | `process`, `channel`, `publishDir`, `script` |
| 2 | Align + Trim + AlnQC | Conda/Docker, shell blocks, `path()` |
| 3 | Tree + GARD | `cpus`/`memory`, `label`, tool containers |
| 4 | Selection + Correction | `.combine()`, `.join()`, parallel fan-out, **strict ordering** |
| 5 | Species Tree + HGT | Subworkflows, module reuse, `.collect()` |
| 6 | Domains + Overlay | Multi-output, file staging, `stageDir` |
| 7 | Network + Temporal + Naming | `.collectFile()`, `val()`, external DBs |
| 8 | Reporting + main.nf | Full wiring, `-resume`, DAG viz, `workflow.onComplete` |

---

## Execution Platforms

| Platform | RAM | CPUs | Recommendation |
|----------|-----|------|----------------|
| **GitHub Codespaces** | 8 GB | 4 | ‚≠ê Primary |
| **Gitpod** | 8 GB | 4 | Alternative |
| **WSL** | Variable | Variable | Offline |
